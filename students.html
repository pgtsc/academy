<div class="w-100 p-0">
  <div class="w-100 mb-2 p-2 card shadow d-flex flex-row gap-1 fw-bold"><span class="material-symbols-rounded">group</span> Student List </div>
  <div class="card shadow">
    <div class="card-body">
      <!-- Filter + Download -->
      <div class="row g-3 align-items-end mb-4">
        <div class="col-md-3">
          <select id="classSelect" class="form-select">
            <option value="">Class</option>
            <option value="6">6</option>
            <option value="7">7</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="sectionSelect" class="form-select">
            <option value="">Section</option>
            <option value="A">A</option>
            <option value="B">B</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="loadStudents()">
            <i class="bi bi-search"></i> Load </button>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-success me-2" onclick="downloadExcel()">
            <i class="bi bi-file-earmark-excel"></i> XLSX </button>
          <button class="btn btn-danger" onclick="downloadPDF()">
            <i class="bi bi-file-earmark-pdf"></i> PDF </button>
        </div>
      </div>
      <!-- Summary Info -->
      <div id="summaryBar" class="py-1 mb-3 d-none border-bottom">
        <span class="material-symbols-rounded">Search</span>
        Class: <span id="sumClass"></span> | Section: <span id="sumSection"></span> | Total Students: <span id="sumTotal"></span>
      </div>
      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>Roll</th>
              <th>Name</th>
              <th>Father</th>
              <th>Mobile</th>
              <th>Stipend</th>
              <th width="110">Action</th>
            </tr>
          </thead>
          <tbody id="studentTable">
            <tr>
              <td colspan="6">Please load data</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
let currentList = [];
const API_URL = "https://script.google.com/macros/s/AKfycbxt0vu3LMvAMpRKf-1isR8Eh0UuELixQ0BlNN-ltsavGmFEmfrGMjaaeT-fbiLV0J72/exec";

/* =========================
   MAIN LOAD FUNCTION
========================= */

async function loadStudents() {

  const cls = document.getElementById("classSelect").value;
  const sec = document.getElementById("sectionSelect").value;

  const studentTable = document.getElementById("studentTable");
  const summaryBar = document.getElementById("summaryBar");
  const sumClass = document.getElementById("sumClass");
  const sumSection = document.getElementById("sumSection");
  const sumTotal = document.getElementById("sumTotal");

  if (!cls || !sec) {
    alert("Please select Class and Section");
    return;
  }

  showLoading(studentTable);

  try {

    const response = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "getStudents",
        cls: cls,
        sec: sec
      })
    });

    const result = await response.json();
    console.log(result)

    if (result.status !== "ok") {
      throw new Error(result.message || "Server error");
    }

    currentList = result.data || [];

    renderStudentTable(currentList, {
      studentTable,
      summaryBar,
      sumClass,
      sumSection,
      sumTotal,
      cls,
      sec
    });

  } catch (error) {
    showError(studentTable, error.message);
    console.error("Student Load Error:", error);
  }
}


/* =========================
   RENDER TABLE
========================= */

function renderStudentTable(data, elements) {

  const {
    studentTable,
    summaryBar,
    sumClass,
    sumSection,
    sumTotal,
    cls,
    sec
  } = elements;

  studentTable.innerHTML = "";

  if (!data.length) {
    summaryBar.classList.add("d-none");
    studentTable.innerHTML = `
      <tr>
        <td colspan="6">No data found</td>
      </tr>`;
    return;
  }

  sumClass.innerText = cls;
  sumSection.innerText = sec;
  sumTotal.innerText = data.length;
  summaryBar.classList.remove("d-none");

  const rows = data.map((s, i) => `
      <tr>
        <td>${s.roll || ""}</td>
        <td>${s.name || ""}</td>
        <td>${s.father || ""}</td>
        <td>${s.mobile || ""}</td>
        <td>${s.stipend || ""}</td>
        <td class="d-flex gap-2 justify-content-center">
          <button class="btn btn-sm btn-primary" onclick="editStudent(${i})">Edit</button>
          <button class="btn btn-sm btn-warning" onclick="sturentProfile(${i})">Profile</button>
        </td>
      </tr>
  `).join("");

  studentTable.innerHTML = rows;
}


/* =========================
   UI HELPERS
========================= */

function showLoading(tableElement) {
  tableElement.innerHTML = `
    <tr>
      <td colspan="6">Loading data...</td>
    </tr>`;
}

function showError(tableElement, message) {
  tableElement.innerHTML = `
    <tr>
      <td colspan="6" class="text-danger">
        ${message || "Error loading data"}
      </td>
    </tr>`;
}

</script>

